<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Un Regalo Speciale per Maria Luisa üíù</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#1a1c29; --card:rgba(23, 30, 50, 0.7); --txt:#f0f4f8; --muted:#94a3b8;
      --accent:#ff9f43; --ok:#2ecc71; --bad:#ff6b6b;
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-btn: linear-gradient(45deg, #11998e, #38ef7d);
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --shadow-soft: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: 'Quicksand', sans-serif;
      background: radial-gradient(circle at top left, #2c3e50, #000000);
      background-size: 200% 200%;
      animation: gradientBG 15s ease infinite;
      color:var(--txt); -webkit-font-smoothing:antialiased;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    @keyframes gradientBG {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    .wrap{max-width:1100px; margin:auto; padding:20px; width: 100%;}
    .card{
      background: var(--card);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius:24px; 
      padding:24px; 
      box-shadow: var(--shadow-soft);
      transition: transform 0.3s ease;
    }
    h1{margin:0 0 10px; font-weight:700; font-size:24px; letter-spacing: -0.5px;}
    p{margin:0 0 16px; color:var(--muted); line-height:1.6; font-size: 16px;}
    
    .row{display:flex; gap:24px; align-items:stretch; flex-wrap:wrap}
    .col{flex:1 1 320px; min-width:280px}
    
    /* Left: percorso visivo */
    .kitchen{
      background: rgba(0,0,0,0.2);
      border-radius:20px; padding:20px; border:1px solid var(--glass-border);
      min-height:400px; display:flex; flex-direction:column; gap:16px;
      position: relative;
      overflow: hidden;
    }
    .kitchen::before {
      content: ''; position: absolute; top: -50px; left: -50px; width: 150px; height: 150px;
      background: var(--accent); opacity: 0.1; filter: blur(50px); border-radius: 50%;
    }
    .path{display:flex; gap:12px; align-items:center; overflow-x:auto; padding-bottom:10px; scrollbar-width: thin;}
    .path::-webkit-scrollbar { height: 6px; }
    .path::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    
    .bowl-area{flex:1; display:flex; align-items:center; justify-content:center; position:relative; min-height: 200px;}
    .bowl{
      width:340px; height:220px; 
      border-radius: 10px 10px 140px 140px; 
      background: linear-gradient(135deg, #4a4e69 0%, #22223b 100%);
      border: 2px solid rgba(255,255,255,0.1);
      border-top: none;
      position:relative; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 -10px 20px rgba(0,0,0,0.5);
      display:flex; align-items:flex-end; justify-content:center; padding-bottom:25px; overflow:visible;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .bowl::after {
      content:''; position:absolute; bottom: -15px; width: 80%; height: 20px;
      background: rgba(0,0,0,0.4); filter: blur(10px); z-index: -1; border-radius: 50%;
    }
    .bowl:hover { transform: translateY(-5px) scale(1.02); }
    
    .bowl .contents{ width:90%; display:flex; gap:6px; justify-content:center; align-items:flex-end; flex-wrap:wrap; position: relative; z-index: 2;}
    .ingredient-pill{ 
      background: rgba(255,255,255,0.15); 
      backdrop-filter: blur(4px);
      padding:4px 8px; border-radius:16px; font-size:11px; font-weight: 600;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      opacity: 0; transform: scale(0.5);
    }
    @keyframes popIn { to { opacity: 1; transform: scale(1); } }
    
    /* Right: domande */
    .question{
      padding:24px; border-radius:20px; 
      background: rgba(255,255,255,0.02);
      border:1px solid var(--glass-border);
      height: 100%;
      display: flex; flex-direction: column;
    }
    
    .cute-avatar {
      font-size: 80px;
      display: flex; align-items: center; justify-content: center;
      width: 140px; height: 140px;
      margin: 0 auto 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: float 4s ease-in-out infinite;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .cute-avatar.happy {
      animation: bounce 0.6s ease;
      transform: scale(1.1);
    }
    .cute-avatar.sad {
      animation: shake 0.5s ease;
      filter: grayscale(0.3);
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      30% { transform: scale(1.2) rotate(-5deg); }
      50% { transform: scale(1.15) rotate(5deg); }
      70% { transform: scale(1.1); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px) rotate(-5deg); }
      40% { transform: translateX(8px) rotate(5deg); }
      60% { transform: translateX(-6px) rotate(-3deg); }
      80% { transform: translateX(6px) rotate(3deg); }
    }
    
    .choices{display:grid; gap:10px; margin-top:12px}
    .btn{ 
      width:100%; border:0; border-radius:12px; padding:12px 16px; font-size:16px; 
      font-weight: 600; font-family: inherit;
      cursor:pointer; 
      background: rgba(255,255,255,0.05); 
      color:var(--txt); text-align:left;
      transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      border: 1px solid transparent;
      display: flex; align-items: center; gap: 10px;
    }
    .btn:hover{ 
      background: rgba(255,255,255,0.1); 
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: rgba(255,255,255,0.1);
    }
    .btn:active { transform: translateX(2px) scale(0.99); }
    
    .btn.primary{ 
      background: var(--gradient-btn); 
      color: #0b1020;
      border: none;
      justify-content: center;
      text-align: center;
      box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);
    }
    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(56, 239, 125, 0.6);
    }
    
    .msg{ 
      margin-top:16px; padding:12px 16px; border-radius:12px; 
      border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.02);
      font-size: 15px; animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:translateY(0)} }
    
    .msg.ok{ border-left: 4px solid var(--ok); background: linear-gradient(90deg, rgba(46, 204, 113, 0.1), transparent); }
    .msg.bad{ border-left: 4px solid var(--bad); background: linear-gradient(90deg, rgba(255, 107, 107, 0.1), transparent); }
    
    .progress{ height:8px; background:rgba(255,255,255,.05); border-radius:999px; overflow:hidden; margin-top: 12px;}
    .bar{ 
      height:100%; width:0%; 
      background: var(--gradient-primary); 
      transition:width .6s cubic-bezier(0.34, 1.56, 0.64, 1); 
      box-shadow: 0 0 10px rgba(118, 75, 162, 0.5);
    }
    
    /* Controlli audio */
    .audio-controls { position:fixed; top:20px; right:20px; display:flex; gap:12px; z-index:100; }
    .audio-btn { 
      width:44px; height:44px; border-radius:50%; 
      border:1px solid rgba(255,255,255,0.2); 
      background: rgba(15,23,48,0.6); 
      color:var(--txt); font-size:20px; cursor:pointer;
      display:flex; align-items:center; justify-content:center; 
      transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(10px); 
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .audio-btn:hover { background:rgba(255,255,255,0.2); transform:rotate(15deg) scale(1.1); }
    .audio-btn.muted { opacity:0.6; filter: grayscale(1); }
    .audio-btn.playing { animation: pulse 2s infinite; border-color: var(--ok); color: var(--ok); }
    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(46, 204, 113, 0.4)} 70%{box-shadow:0 0 0 10px rgba(46, 204, 113, 0)} 100%{box-shadow:0 0 0 0 rgba(46, 204, 113, 0)} }
    
    /* confetti improved */
    .confetti i{ 
      position:absolute; width:8px; height:8px; 
      background:var(--accent); 
      border-radius: 50%;
      animation: fall 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      box-shadow: 0 0 5px currentColor;
    }
    @keyframes fall { 
      0% { transform: translateY(-20px) scale(0); opacity: 0; }
      20% { opacity: 1; transform: translateY(0) scale(1.2); }
      100% { transform: translateY(200px) rotate(720deg) scale(0.5); opacity:0; } 
    }
    
    /* Avatar SVG animato */
    .avatar-svg { width:120px; height:120px; }
    .avatar-svg .eye { animation: blink 4s infinite; transform-origin: center; }
    .avatar-svg .pupil { animation: lookAround 6s infinite ease-in-out; }
    .avatar-svg .mouth { transition: d 0.3s ease; }
    .avatar-svg.talking .mouth { animation: talk 0.3s infinite; }
    .avatar-svg.happy .mouth { animation: none; }
    .avatar-svg.sad .mouth { animation: none; }
    .avatar-svg .eyebrow { transition: transform 0.3s ease; transform-origin: center; }
    .avatar-svg.sad .eyebrow-left { transform: rotate(15deg) translateY(2px); }
    .avatar-svg.sad .eyebrow-right { transform: rotate(-15deg) translateY(2px); }
    .avatar-svg.happy .eyebrow-left { transform: rotate(-10deg) translateY(-2px); }
    .avatar-svg.happy .eyebrow-right { transform: rotate(10deg) translateY(-2px); }
    @keyframes blink { 0%,96%,100%{transform:scaleY(1)} 98%{transform:scaleY(0.1)} }
    @keyframes lookAround { 0%,100%{transform:translateX(0)} 25%{transform:translateX(2px)} 75%{transform:translateX(-2px)} }
    @keyframes talk { 0%,100%{transform:scaleY(1)} 50%{transform:scaleY(0.6)} }
    
    /* Ciotola che bolle */
    .bowl { position:relative; }
    .bowl.boiling::before { 
      content:''; position:absolute; top:-20px; left:50%; transform:translateX(-50%);
      width:80%; height:40px; background: radial-gradient(ellipse, rgba(255,255,255,0.15) 0%, transparent 70%);
      animation: steam 2s infinite ease-out; opacity:0;
    }
    .bowl.boiling .bubble { position:absolute; background:rgba(255,200,100,0.6); border-radius:50%; animation: bubble 1.5s infinite ease-out; }
    @keyframes steam { 0%{opacity:0;transform:translateX(-50%) translateY(0)} 50%{opacity:0.6} 100%{opacity:0;transform:translateX(-50%) translateY(-30px)} }
    @keyframes bubble { 0%{transform:translateY(0) scale(1);opacity:0.8} 100%{transform:translateY(-40px) scale(0.3);opacity:0} }
    @keyframes bowlShake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px) rotate(-1deg)} 75%{transform:translateX(3px) rotate(1deg)} }
    .bowl.adding { animation: bowlShake 0.4s ease-in-out; }
    
    /* Percorso SVG */
    .path-svg { width:100%; height:80px; margin-bottom:10px; }
    .path-line { stroke: rgba(255,255,255,0.1); stroke-width:3; fill:none; stroke-dasharray: 8 4; }
    .path-line-progress { stroke: var(--ok); stroke-width:3; fill:none; stroke-dasharray: 1000; stroke-dashoffset: 1000; transition: stroke-dashoffset 0.8s ease-out; }
    .path-node { fill: rgba(255,255,255,0.05); stroke: rgba(255,255,255,0.1); stroke-width:2; transition: all 0.4s ease; cursor:pointer; }
    .path-node.active { fill: rgba(61,220,151,0.2); stroke: var(--ok); animation: nodeGlow 1.5s ease-in-out; }
    .path-node:hover { transform: scale(1.1); }
    @keyframes nodeGlow { 0%{filter:drop-shadow(0 0 0 transparent)} 50%{filter:drop-shadow(0 0 15px rgba(61,220,151,0.6))} 100%{filter:drop-shadow(0 0 0 transparent)} }
    .path-icon { font-size:20px; transition: transform 0.3s ease; }
    .path-node.active .path-icon { animation: iconPop 0.5s ease-out; }
    @keyframes iconPop { 0%{transform:scale(0)} 50%{transform:scale(1.3)} 100%{transform:scale(1)} }
    
    /* responsive */
    @media (max-width:900px){
      .row{flex-direction:column}
      .avatar{ margin-bottom:6px }
      .bowl{ width:260px; height:160px }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app">
      <!-- render via JS -->
    </div>
  </div>

  <script>
    /**********************
     * SISTEMA AUDIO
     **********************/
    const AudioSystem = {
      ctx: null,
      musicGain: null,
      sfxGain: null,
      
      // Stati
      musicMuted: false,
      sfxMuted: false,
      musicPlaying: false,
      
      // Scheduling (Lookahead system)
      nextNoteTime: 0.0,
      currentNoteIndex: 0,
      timerID: null,
      tempo: 0.25, // Durata base della nota in secondi (veloce/allegro)
      melody: [
        // C Major Joyful Pattern (Continuous)
        261.63, 329.63, 392.00, 523.25, // C E G C
        392.00, 329.63, 261.63, 196.00, // G E C G_low
        293.66, 349.23, 392.00, 440.00, // D F G A
        392.00, 349.23, 293.66, 392.00, // G F D G
        329.63, 392.00, 523.25, 659.25, // E G C E
        523.25, 392.00, 329.63, 261.63, // C G E C
        349.23, 440.00, 523.25, 587.33, // F A C D
        523.25, 493.88, 392.00, 261.63  // C B G C
      ],

      init() {
        if (this.ctx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
        
        this.musicGain = this.ctx.createGain();
        this.musicGain.gain.value = 0.10; // Volume musica basso
        this.musicGain.connect(this.ctx.destination);
        
        this.sfxGain = this.ctx.createGain();
        this.sfxGain.gain.value = 0.40; // Volume SFX normale
        this.sfxGain.connect(this.ctx.destination);
      },

      startMusic() {
        // Se √® gi√† in riproduzione, NON fare nulla per evitare interruzioni/reset
        if (this.musicPlaying && !this.musicMuted) return;
        if (this.musicMuted) return;

        this.init();
        if (this.ctx.state === 'suspended') this.ctx.resume();

        this.musicPlaying = true;
        this.currentNoteIndex = 0;
        this.nextNoteTime = this.ctx.currentTime + 0.1; // Primo start
        
        this.scheduleLoop();
        this.updateMusicButton();
      },

      scheduleLoop() {
        if (!this.musicPlaying) return;
        
        const lookahead = 0.1; // 100ms di anticipo
        const currentTime = this.ctx.currentTime;

        // Pianifica tutte le note che devono suonare nel prossimo intervallo
        while (this.nextNoteTime < currentTime + lookahead) {
            this.playScheduledNote(this.nextNoteTime);
            this.nextNote();
        }

        this.timerID = setTimeout(() => this.scheduleLoop(), 25);
      },

      playScheduledNote(time) {
        // Ottieni frequenza
        const freq = this.melody[this.currentNoteIndex % this.melody.length];
        
        // Suona
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        
        // Envelope breve e staccato
        const dur = this.tempo * 0.8; 
        
        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(0.1, time + 0.02);
        gain.gain.setValueAtTime(0.1, time + dur - 0.02);
        gain.gain.linearRampToValueAtTime(0, time + dur);
        
        osc.connect(gain);
        gain.connect(this.musicGain);
        
        osc.start(time);
        osc.stop(time + dur + 0.05); // Cleanup sicuro
        
        osc.onended = () => {
            osc.disconnect();
            gain.disconnect();
        };
      },

      nextNote() {
        // Avanza tempo e indice
        this.nextNoteTime += this.tempo;
        this.currentNoteIndex++;
      },

      stopMusic() {
        this.musicPlaying = false;
        if (this.timerID) clearTimeout(this.timerID);
        this.updateMusicButton();
      },
      
      // --- SFX (Effetti Sonori) ---
      
      playCorrect() {
        if (this.sfxMuted) return;
        this.init(); this.ctx.resume();
        const now = this.ctx.currentTime;
        // Trillo ascendente rapido
        [523.25, 659.25, 783.99, 1046.50].forEach((f,i) => this.playToneSfx(f, now+i*0.08, 0.2, 'sine'));
        this.vibrate([50]);
      },

      playWrong() {
        if (this.sfxMuted) return;
        this.init(); this.ctx.resume();
        const now = this.ctx.currentTime;
        this.playToneSfx(200, now, 0.3, 'sawtooth', true); // Buzz
        this.vibrate([100]);
      },
      
      playClick() {
        if (this.sfxMuted) return;
        this.init(); this.ctx.resume();
        this.playToneSfx(880, this.ctx.currentTime, 0.05, 'sine');
      },
      
      playVictory() {
        if (this.sfxMuted) return;
        this.init(); this.ctx.resume();
        const now = this.ctx.currentTime;
        // Fanfara semplice sovrapposta alla musica
        this.playToneSfx(523.25, now, 0.4, 'square');       // C
        this.playToneSfx(783.99, now + 0.1, 0.4, 'square'); // G
        this.playToneSfx(1046.50, now + 0.2, 0.8, 'square'); // C high
        this.vibrate([100, 50, 100, 50, 200]);
      },
      
      playGameOver() {
        // Non usato nel design attuale ma teniamo la funzione
        if (this.sfxMuted) return;
        this.init(); this.ctx.resume();
        const now = this.ctx.currentTime;
        [392, 349.23, 330, 261].forEach((f,i) => this.playToneSfx(f, now+i*0.3, 0.5, 'sine'));
      },
      
      playToneSfx(freq, time, dur, type, slideDown=false) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, time);
        if(slideDown) osc.frequency.exponentialRampToValueAtTime(Math.max(freq/4, 40), time + dur);
        
        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(0.3, time + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.01, time + dur);
        
        osc.connect(gain);
        gain.connect(this.sfxGain);
        osc.start(time);
        osc.stop(time + dur + 0.1);
        
        osc.onended = () => {
             osc.disconnect();
             gain.disconnect();
        };
      },

      toggleMusic() {
        this.musicMuted = !this.musicMuted;
        const now = this.ctx.currentTime;
        
        if (this.musicMuted) {
             // Fade out rapido
             if(this.musicGain) this.musicGain.gain.linearRampToValueAtTime(0, now + 0.2);
             this.stopMusic();
        } else {
             if(this.musicGain) {
                 this.musicGain.gain.setValueAtTime(0, now);
                 this.musicGain.gain.linearRampToValueAtTime(0.1, now + 0.5);
             }
             this.startMusic();
        }
        this.updateMusicButton();
      },
      
      toggleSfx() {
        this.sfxMuted = !this.sfxMuted;
        if (!this.sfxMuted) this.playClick();
        this.updateSfxButton();
      },
      
      updateMusicButton() {
        const btn = document.getElementById('musicBtn');
        if (btn) {
          btn.textContent = this.musicMuted ? 'üîá' : 'üéµ';
          btn.classList.toggle('muted', this.musicMuted);
          btn.classList.toggle('playing', this.musicPlaying);
        }
      },
      
      updateSfxButton() {
        const btn = document.getElementById('sfxBtn');
        if (btn) {
          btn.textContent = this.sfxMuted ? 'üîï' : 'üîî';
          btn.classList.toggle('muted', this.sfxMuted);
        }
      },
      
      vibrate(pattern) {
        if ('vibrate' in navigator) navigator.vibrate(pattern);
      }
    };
    
    // Crea i controlli audio
    function createAudioControls() {
      const existing = document.querySelector('.audio-controls');
      if (existing) return;
      
      const controls = document.createElement('div');
      controls.className = 'audio-controls';
      controls.innerHTML = `
        <button id="musicBtn" class="audio-btn muted" onclick="AudioSystem.toggleMusic()" title="Musica">üîá</button>
        <button id="sfxBtn" class="audio-btn" onclick="AudioSystem.toggleSfx()" title="Effetti sonori">üîî</button>
      `;
      document.body.appendChild(controls);
    }

    /**********************
     * CONFIGURAZIONE
     **********************/
    const GAME = {
      title: "Un Viaggio Culinario Speciale",
      heroineName: "Maria Luisa",
      dishName: "Ramen al miso",
      targetIngredients: ["Aglio & Zenzero","Spinaci/Bok choy","Cipollotto (Negi)","Bamboo shoots","Chashu (pork)","Ajitama (uovo)","Miso paste","Ramen noodles"],
      // DOMANDE in ordine di scoperta (dal vago al rivelatore)
      questions: [
        { q: "Iniziamo dalle basi. Quale coppia di aromi freschi √® indispensabile per dare profumo e un tocco piccante al soffritto iniziale?", choices:["Cipolla e sedano","Aglio e zenzero","Basilico e prezzemolo","Carota e cipolla"], correctIndex:1, ingredient:"Aglio & Zenzero", hint:"Una radice e un bulbo molto usati in Asia." },
        { q: "Per dare colore e salute al piatto, sbollentiamo velocemente queste verdure a foglia verde...", choices:["Lattuga","Spinaci o Bok choy","Rucola","Verza"], correctIndex:1, ingredient:"Spinaci/Bok choy", hint:"Foglie verdi che appassiscono in fretta nel brodo caldo." },
        { q: "Tagliato a rondelle sottili, questo ingrediente fresco aggiunge una nota croccante e pungente alla fine...", choices:["Cipollotto (Negi)","Peperone","Zucchina","Prezzemolo"], correctIndex:0, ingredient:"Cipollotto (Negi)", hint:"Simile alla cipolla ma verde e lungo." },
        { q: "Un tocco di croccantezza particolare: germogli fermentati che vengono da una pianta altissima...", choices:["Asparagi","Bamboo shoots (Menma)","Cuori di palma","Carciofi"], correctIndex:1, ingredient:"Bamboo shoots", hint:"Il cibo preferito dei panda!" },
        { q: "Passiamo alla sostanza: fette di maiale brasato lentamente che si sciolgono in bocca. Come si chiamano?", choices:["Prosciutto cotto","Chashu","Cotoletta","Spezzatino"], correctIndex:1, ingredient:"Chashu (pork)", hint:"Cotto a lungo nella salsa di soia e mirin." },
        { q: "Non √® un semplice uovo sodo, ma un uovo marinato col tuorlo cremoso. Qual √® il suo nome?", choices:["Uovo in camicia","Frittata","Ajitama","Uovo strapazzato"], correctIndex:2, ingredient:"Ajitama (uovo)", hint:"Marinato per ore assorbe sapore e colore." },
        { q: "L'anima sapida della nostra zuppa. Una pasta fermentata che dona un gusto profondo...", choices:["Concentrato di pomodoro","Miso","Pesto","Senape"], correctIndex:1, ingredient:"Miso paste", hint:"Fatto con soia fermentata." },
        { q: "E infine, l'ingrediente che definisce il piatto! Pasta elastica e gialla fatta per essere 'slurpata'...", choices:["Spaghetti","Riso","Ramen noodles","Tagliatelle"], correctIndex:2, ingredient:"Ramen noodles", hint:"L'ingrediente che d√† il nome al piatto!" }
      ],
      allowRetry: true,
      maxMistakes: 3
    };

    /**********************
     * STATO
     **********************/
    let state = { screen: "start", idx: 0, mistakes: 0, collected: [] };
    const app = document.getElementById("app");

    /**********************
     * RENDER PRINCIPALE
     **********************/
    function render(){
      if(state.screen === "start") return renderStart();
      if(state.screen === "question") return renderQuestion();
      if(state.screen === "win") return renderWin();
      if(state.screen === "lose") return renderLose();
    }

    function renderStart(){
      app.innerHTML = `
        <div class="row" style="align-items: center; min-height: 400px;">
          <div class="col">
            <h1 style="font-size: 32px; background: linear-gradient(to right, #fff, #a5b4fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üíù ${GAME.title}</h1>
            <p style="font-size: 18px;">Ciao <b>${GAME.heroineName}</b>! üå∏</p>
            <p style="font-size: 16px; opacity: 0.9;">Ho preparato un piccolo gioco culinario per te... Rispondi correttamente alle domande per raccogliere tutti gli ingredienti segreti.</p>
            <p class="small" style="color:var(--accent); font-style:italic; border-left: 2px solid var(--accent); padding-left: 10px;">Ogni risposta giusta ti avvicina alla rivelazione finale... ‚ú®</p>
            <div style="display:flex; gap:12px; margin-top:24px;">
              <button class="btn primary" onclick="startGame()" style="width: auto; padding: 12px 32px; font-size: 18px;">üåü Inizia l'avventura</button>
            </div>
          </div>
          <div class="col" style="text-align:center; position: relative;">
             <div style="position: absolute; width: 200px; height: 200px; background: var(--gradient-primary); filter: blur(60px); opacity: 0.3; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; z-index: 0;"></div>
            <div class="cute-avatar" id="startAvatar" style="position: relative; z-index: 1;">üë©üèª‚Äçüç≥</div>
            <p class="small" style="margin-top:16px; color:var(--muted); letter-spacing: 1px; text-transform: uppercase; font-size: 12px; font-weight: 600;">Sei pronta a cucinare?</p>
          </div>
        </div>
      `;
    }

    function renderQuestion(messageHtml=""){
      const total = GAME.questions.length;
      const q = GAME.questions[state.idx];
      const pct = Math.round((state.idx / total) * 100);

      // left visual path + bowl
      const left = `
        <div class="kitchen">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <strong>Ingredienti raccolti</strong>
            <div style="font-size:13px; color:var(--muted)">${state.collected.length}/${GAME.questions.length} ingredienti</div>
          </div>
          <div class="path" id="pathArea">
            ${createPathSVG()}
            <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center; margin-top:8px;">
              ${GAME.targetIngredients.map((it,i) => {
                const isCollected = state.collected.includes(it);
                const label = isCollected ? escapeHtml(shortLabel(it)) : '???';
                return `<span style="font-size:11px; color:${isCollected ? 'var(--ok)' : 'var(--muted)'}; padding:2px 6px; background:rgba(255,255,255,0.03); border-radius:8px;">${label}</span>`;
              }).join('')}
            </div>
          </div>

          <div class="bowl-area">
            <div class="bowl" id="bowl">
              <div class="contents" id="bowlContents">
                ${state.collected.map(ci => `<div class="ingredient-pill">${emojiFor(ci)} ${escapeHtml(shortLabel(ci))}</div>`).join('')}
              </div>
            </div>
            <div class="confetti" id="confetti"></div>
          </div>
        </div>
      `;

      // right question panel
      const right = `
        <div class="question">
          <div style="display:flex; align-items:center; gap:12px;">
            <div>
              <div class="cute-avatar" id="heroAvatar">üë©üèª‚Äçüç≥</div>
              <div class="avatar-label" style="text-align:center; font-size:13px; color:var(--muted)">${GAME.heroineName}</div>
            </div>
            <div style="flex:1">
              <h1 style="font-size:16px; margin-bottom:6px">Domanda ${state.idx+1} / ${total}</h1>
              <p style="margin-bottom:6px">${escapeHtml(q.q)}</p>
              <div class="progress" title="Progresso"><div class="bar" style="width:${pct}%"></div></div>
            </div>
          </div>

          <div class="choices" id="choices">${q.choices.map((c,i) =>
            `<button class="btn" onclick="answer(${i})"> ${escapeHtml(c)}</button>`).join('')}</div>

          ${messageHtml ? `<div>${messageHtml}</div>` : ""}
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="btn" onclick="restart()">Ricomincia</button>
            ${q.hint ? `<button class="btn" onclick="showHint()">üí° Suggerimento</button>` : ""}
          </div>
        </div>
      `;

      app.innerHTML = `<div class="row"><div class="col">${left}</div><div class="col">${right}</div></div>`;

      // aggiorna avatar classe se necessario
      updateAvatarState();
    }

    function renderWin(){
      app.innerHTML = `
        <div style="text-align:center; padding:30px 20px; position:relative; overflow:hidden;">
          <div style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0;">
             <div style="position:absolute; top:10%; left:10%; width:10px; height:10px; background:#ffd700; border-radius:50%; box-shadow:0 0 10px #ffd700; animation: float 3s infinite;"></div>
             <div style="position:absolute; top:20%; right:15%; width:8px; height:8px; background:#ff9f43; border-radius:50%; box-shadow:0 0 10px #ff9f43; animation: float 4s infinite reverse;"></div>
          </div>
          
          <h1 style="font-size:36px; margin-bottom:10px; animation: slideUp 0.6s ease-out;">üéâüå∏ Bravissima ${GAME.heroineName}! üå∏üéâ</h1>
          <p style="font-size:18px; margin:0 0 24px; animation: slideUp 0.6s ease-out 0.1s backwards;">Hai completato la ricetta segreta!</p>
          
          <div style="
            background: rgba(255,255,255,0.05); 
            backdrop-filter: blur(10px);
            border-radius:24px; padding:30px; margin:0 auto 30px; max-width:550px; 
            border:1px solid rgba(255,255,255,0.1);
            transform-origin: center;
            animation: popIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s backwards;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
          ">
            <div style="font-size:60px; margin-bottom:16px; display:inline-block; animation: bounce 1s infinite alternate;">üçú</div>
            <h2 style="color:var(--accent); margin:0 0 8px; font-size: 16px; text-transform: uppercase; letter-spacing: 2px;">Il piatto misterioso √®</h2>
            <h1 style="font-size:38px; color:var(--txt); margin:0; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${GAME.dishName}</h1>
          </div>
          
          <div class="bowl" style="margin:0 auto 30px; width:300px; height:180px; animation: slideUp 0.8s ease-out 0.5s backwards;">
            <div style="display:flex; gap:6px; justify-content:center; align-items:flex-end; padding-bottom:20px; flex-wrap:wrap">
              ${GAME.targetIngredients.map((it, i) => `<div class="ingredient-pill" style="animation-delay: ${0.8 + (i*0.1)}s">${emojiFor(it)} ${shortLabel(it)}</div>`).join('')}
            </div>
          </div>
          
          <div id="invitation-card" style="
             background: linear-gradient(135deg, rgba(61,220,151,0.1), rgba(255,184,107,0.1)); 
             border-radius:20px; padding:30px; margin:0 auto; max-width:500px; 
             border:1px solid rgba(255,255,255,0.15);
             animation: slideUp 1s cubic-bezier(0.22, 1, 0.36, 1) 1.5s backwards;
             position: relative;
             overflow: hidden;
          ">
            <div style="position: absolute; top:-50px; left:-50px; width:100px; height:100px; background:linear-gradient(45deg, transparent, rgba(255,255,255,0.1)); transform:rotate(45deg);"></div>
            
            <p style="font-size:16px; color:var(--muted); margin:0 0 12px; font-style:italic;">üíå E ora... la vera sorpresa:</p>
            <p style="font-size:20px; color:var(--txt); margin:0 0 16px; font-weight:700; line-height: 1.4;">Ti invito ufficialmente a cena per <br><span style="color:var(--accent)">sabato 14 febbraio 2026</span>! üåπ</p>
            
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-top: 15px;">
              <p style="font-size:15px; margin:0; line-height:1.6;">P.S. Non preoccuparti di rispondere... ho gi√† prenotato per le 21:00! üòé</p>
              <div style="margin-top: 10px;">
                <a href="https://www.thefork.it/ristorante/aroma-asian-gourmet-specialita-ramen-r826159/menu" target="_blank" style="
                  display: inline-block;
                  background: var(--gradient-btn);
                  color: #0b1020;
                  text-decoration: none;
                  padding: 8px 16px;
                  border-radius: 20px;
                  font-weight: bold;
                  font-size: 14px;
                  box-shadow: 0 4px 10px rgba(56, 239, 125, 0.3);
                  transition: transform 0.2s;
                ">Vedi il Menu: Aroma Asian Gourmet üçú</a>
              </div>
            </div>
            
            <p style="font-size:15px; color:var(--muted); margin-top:20px; font-family: cursive;">‚Äî Con affetto, Giacomino ‚ù§Ô∏è</p>
          </div>
          
          <div style="margin-top:30px; animation: fadeIn 1s ease-out 2.5s backwards;">
            <button class="btn" onclick="restart()" style="opacity:0.7; width: auto; display: inline-flex; margin: auto;">üîÑ Rigioca il ricordo</button>
          </div>
        </div>
      `;
    }

    function renderLose(){
      app.innerHTML = `
        <div style="text-align:center; padding:20px;">
          <div style="font-size:64px; margin-bottom:16px;">ü•∫</div>
          <h1>Oh no!</h1>
          <p style="font-size:16px;">Niente paura ${GAME.heroineName}, la sorpresa ti aspetta ancora! üíï</p>
          <p style="color:var(--muted);">Riprova e scoprirai cosa ho preparato per te...</p>
          <div style="margin-top:20px">
            <button class="btn primary" onclick="restart()">‚ú® Riprova</button>
          </div>
        </div>
      `;
    }

    /**********************
     * AZIONI / LOGICA
     **********************/
    window.startGame = function(){
      AudioSystem.playClick();
      AudioSystem.startMusic('normal');
      state = { screen: "question", idx: 0, mistakes: 0, collected: [] };
      render();
    };

    window.restart = function(){
      AudioSystem.playClick();
      AudioSystem.startMusic('normal');
      state = { screen: "start", idx: 0, mistakes: 0, collected: [] };
      render();
    };

    window.showHowTo = function(){
      const el = document.getElementById("howto");
      if(el) el.innerHTML = "Rispondi alle domande: ogni risposta corretta aggiunge un ingrediente alla ciotola. Se sbagli diventi triste; dopo alcuni errori perdi. Buon viaggio culinario!";
    };

    window.showHint = function(){
      const q = GAME.questions[state.idx];
      renderQuestion(`<div class="msg">üí° <b>Suggerimento:</b> ${escapeHtml(q.hint)}</div>`);
    };

    window.answer = function(choiceIndex){
      const q = GAME.questions[state.idx];
      const correct = choiceIndex === q.correctIndex;

      if(correct){
        // colleziona l'ingrediente (se presente)
        if(q.ingredient && !state.collected.includes(q.ingredient)){
          state.collected.push(q.ingredient);
        }
        // suono e feedback tattile
        AudioSystem.playCorrect();
        // animazione di successo
        triggerConfetti();
        setAvatarExpression('happy');
        state.idx += 1;
        if(state.idx >= GAME.questions.length){
          state.screen = "win";
          setTimeout(() => AudioSystem.playVictory(), 300);
          setTimeout(() => AudioSystem.startMusic('victory'), 300);
          return setTimeout(render, 700);
        }
        // mostra messaggio e poi re-render
        return setTimeout(() => renderQuestion(`<div class="msg ok">‚úÖ Esatto! Hai aggiunto <b>${escapeHtml(q.ingredient || "un ingrediente")}</b> alla ciotola.</div>`), 220);
      } else {
        state.mistakes += 1;
        // suono e feedback tattile
        AudioSystem.playWrong();
        setAvatarExpression('sad');
        if(!GAME.allowRetry || state.mistakes >= GAME.maxMistakes){
          state.screen = "lose";
          setTimeout(() => AudioSystem.playGameOver(), 300);
          return setTimeout(render, 700);
        }
        // mostrato messaggio di errore
        return setTimeout(() => renderQuestion(`<div class="msg bad">‚ùå Non √® corretto. Errori: ${state.mistakes}/${GAME.maxMistakes}</div>`), 200);
      }
    };

    /**********************
     * HELPERS (animazioni, avatar, mapping)
     **********************/
    function avatarEmoji(){
      // base neutral avatar with name initial
      return "üë©üèª‚Äçüç≥";
    }

    function createAvatarSVG(expression = 'neutral') {
      // Espressioni: mouth paths
      const mouths = {
        neutral: 'M35,70 Q50,75 65,70',
        happy: 'M35,68 Q50,82 65,68',
        sad: 'M35,75 Q50,65 65,75',
        talking: 'M38,70 Q50,78 62,70'
      };
      const mouthPath = mouths[expression] || mouths.neutral;
      const eyeScaleY = expression === 'happy' ? 0.6 : 1;
      const extraClass = expression !== 'neutral' ? expression : '';
      
      return `
        <svg class="avatar-svg ${extraClass}" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <!-- Sfondo -->
          <defs>
            <linearGradient id="skinGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#ffe0bd"/>
              <stop offset="100%" style="stop-color:#f5c9a6"/>
            </linearGradient>
            <linearGradient id="hairGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#2a1a0a"/>
              <stop offset="100%" style="stop-color:#1a0f05"/>
            </linearGradient>
          </defs>
          
          <!-- Capelli dietro -->
          <ellipse cx="50" cy="35" rx="42" ry="35" fill="url(#hairGrad)"/>
          <ellipse cx="50" cy="55" rx="38" ry="25" fill="url(#hairGrad)"/>
          
          <!-- Viso -->
          <ellipse cx="50" cy="50" rx="32" ry="36" fill="url(#skinGrad)"/>
          
          <!-- Capelli davanti -->
          <path d="M20,35 Q25,15 50,12 Q75,15 80,35 Q75,25 50,22 Q25,25 20,35" fill="url(#hairGrad)"/>
          <ellipse cx="22" cy="45" rx="8" ry="15" fill="url(#hairGrad)"/>
          <ellipse cx="78" cy="45" rx="8" ry="15" fill="url(#hairGrad)"/>
          
          <!-- Sopracciglia -->
          <path class="eyebrow eyebrow-left" d="M30,38 Q36,35 42,38" stroke="#4a3520" stroke-width="2" fill="none" stroke-linecap="round"/>
          <path class="eyebrow eyebrow-right" d="M58,38 Q64,35 70,38" stroke="#4a3520" stroke-width="2" fill="none" stroke-linecap="round"/>
          
          <!-- Occhi -->
          <g class="eye" style="transform-origin:36px 47px">
            <ellipse cx="36" cy="47" rx="6" ry="${7 * eyeScaleY}" fill="white"/>
            <circle class="pupil" cx="36" cy="47" r="3" fill="#3a2a1a"/>
            <circle cx="34" cy="45" r="1" fill="white" opacity="0.8"/>
          </g>
          <g class="eye" style="transform-origin:64px 47px">
            <ellipse cx="64" cy="47" rx="6" ry="${7 * eyeScaleY}" fill="white"/>
            <circle class="pupil" cx="64" cy="47" r="3" fill="#3a2a1a"/>
            <circle cx="62" cy="45" r="1" fill="white" opacity="0.8"/>
          </g>
          
          <!-- Naso -->
          <path d="M50,52 L48,58 Q50,60 52,58 Z" fill="#e8b090" opacity="0.6"/>
          
          <!-- Guance (blush) -->
          <ellipse cx="28" cy="58" rx="6" ry="3" fill="#ffb3b3" opacity="${expression === 'happy' ? 0.5 : 0.25}"/>
          <ellipse cx="72" cy="58" rx="6" ry="3" fill="#ffb3b3" opacity="${expression === 'happy' ? 0.5 : 0.25}"/>
          
          <!-- Bocca -->
          <path class="mouth" d="${mouthPath}" stroke="#c47a6a" stroke-width="2.5" fill="${expression === 'happy' ? '#ff9999' : 'none'}" stroke-linecap="round"/>
          
          <!-- Cappello da chef -->
          <ellipse cx="50" cy="18" rx="28" ry="12" fill="white"/>
          <rect x="28" y="8" width="44" height="14" rx="4" fill="white"/>
          <ellipse cx="50" cy="5" rx="18" ry="8" fill="white"/>
          <ellipse cx="42" cy="3" rx="8" ry="5" fill="#f8f8f8"/>
          <ellipse cx="58" cy="3" rx="8" ry="5" fill="#f8f8f8"/>
          <ellipse cx="50" cy="0" rx="6" ry="4" fill="#f0f0f0"/>
        </svg>
      `;
    }

    function createPathSVG() {
      const total = GAME.targetIngredients.length;
      const width = 100;
      const nodeSpacing = width / (total + 1);
      
      let nodes = '';
      let pathD = 'M ';
      
      GAME.targetIngredients.forEach((it, i) => {
        const x = nodeSpacing * (i + 1);
        const y = 40 + Math.sin(i * 0.8) * 15; // Percorso ondulato
        const isCollected = state.collected.includes(it);
        const icon = isCollected ? emojiFor(it) : '‚ùì';
        const activeClass = isCollected ? 'active' : '';
        
        if (i === 0) pathD += `${x} ${y}`;
        else pathD += ` Q ${x - nodeSpacing/2} ${y + (i % 2 ? -20 : 20)}, ${x} ${y}`;
        
        nodes += `
          <g class="path-node ${activeClass}" data-ingredient="${escapeHtml(it)}" transform="translate(${x}, ${y})">
            <circle r="14" cx="0" cy="0"/>
            <text class="path-icon" x="0" y="5" text-anchor="middle" font-size="16">${icon}</text>
          </g>
        `;
      });
      
      const progress = state.collected.length / total;
      const dashOffset = 1000 - (1000 * progress);
      
      return `
        <svg class="path-svg" viewBox="0 0 100 80" preserveAspectRatio="xMidYMid meet">
          <path class="path-line" d="${pathD}"/>
          <path class="path-line-progress" d="${pathD}" style="stroke-dashoffset:${dashOffset}"/>
          ${nodes}
        </svg>
      `;
    }

    function triggerBowlBoil() {
      const bowl = document.getElementById('bowl');
      if (!bowl) return;
      
      bowl.classList.add('boiling', 'adding');
      
      // Aggiungi bolle
      for (let i = 0; i < 6; i++) {
        setTimeout(() => {
          const bubble = document.createElement('div');
          bubble.className = 'bubble';
          bubble.style.left = (20 + Math.random() * 60) + '%';
          bubble.style.bottom = '30%';
          bubble.style.width = bubble.style.height = (8 + Math.random() * 12) + 'px';
          bubble.style.animationDelay = (Math.random() * 0.5) + 's';
          bowl.appendChild(bubble);
          setTimeout(() => bubble.remove(), 1500);
        }, i * 150);
      }
      
      setTimeout(() => {
        bowl.classList.remove('adding');
      }, 400);
      
      setTimeout(() => {
        bowl.classList.remove('boiling');
      }, 2000);
    }

    function setAvatarTalking(talking) {
      const avatar = document.querySelector('.avatar-svg');
      if (!avatar) return;
      if (talking) {
        avatar.classList.add('talking');
      } else {
        avatar.classList.remove('talking');
      }
    }

    function setAvatarExpression(expr){
      // Aggiorna l'avatar emoji con animazione
      const el = document.getElementById('heroAvatar');
      if(el) {
        el.classList.remove('happy', 'sad');
        if(expr === 'happy') {
          el.textContent = 'üòä';
          el.classList.add('happy');
        } else if(expr === 'sad') {
          el.textContent = 'üòû';
          el.classList.add('sad');
        } else {
          el.textContent = 'üë©üèª‚Äçüç≥';
        }
      }
      
      // Attiva animazione della ciotola se risposta corretta
      if(expr === 'happy') {
        triggerBowlBoil();
      }
      
      // torna neutro dopo un po'
      clearTimeout(window._exprTO);
      window._exprTO = setTimeout(()=>{ 
        if(el) {
          el.textContent = 'üë©üèª‚Äçüç≥';
          el.classList.remove('happy', 'sad');
        }
      }, 2000);
      
      // aggiorna bowl grafica
      updateBowlContents();
    }

    function updateAvatarState(){
      // all'avvio della schermata domanda, mostra espressione neutra
      const el = document.getElementById('heroAvatar');
      if(el) el.classList.remove('happy','sad');
      updateBowlContents();
    }

    function updateBowlContents(){
      const contents = document.getElementById('bowlContents');
      if(!contents) return;
      contents.innerHTML = state.collected.map(ci => `<div class="ingredient-pill">${emojiFor(ci)} ${escapeHtml(shortLabel(ci))}</div>`).join('');
      // aggiorna path: mark active quelli raccolti
      document.querySelectorAll('#pathArea .step').forEach(node=>{
        const ing = node.getAttribute('data-ingredient');
        if(state.collected.includes(ing)) node.classList.add('active');
        else node.classList.remove('active');
      });
      // aggiorna barra progresso
      const pct = Math.round((state.collected.length / GAME.targetIngredients.length) * 100);
      const bar = document.querySelector('.bar');
      if(bar) bar.style.width = pct + '%';
    }

    function triggerConfetti(){
      // genera pi√π elementi confetti nell'area bowl
      const wrap = document.getElementById('confetti');
      if(!wrap) return;
      const colors = ['#FFD97D','#FF9AA2','#B8F2E6','#9EE493', '#ff9f43', '#54a0ff'];
      
      for(let i=0;i<30;i++){
        const el = document.createElement('i');
        el.style.left = (10 + Math.random()*80) + '%';
        el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        // Randomize size
        const size = 6 + Math.random()*8;
        el.style.width = size + 'px';
        el.style.height = size + 'px';
        el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        
        el.style.top = (20 + Math.random()*20) + '%';
        el.style.transform = `translateY(-10px) rotate(${Math.random()*360}deg)`;
        
        // Randomize animation
        const duration = 800 + Math.random()*600;
        el.style.animationDuration = duration + 'ms';
        el.style.animationDelay = (Math.random()*200) + 'ms';
        
        wrap.appendChild(el);
        setTimeout(()=> el.remove(), duration + 300);
      }
    }

    function emojiFor(label){
      // mapping semplice per icone
      const m = {
        "Miso paste":"üßÇ","Ramen noodles":"üçú","Chashu (pork)":"ü•©","Ajitama (uovo)":"ü•ö",
        "Spinaci/Bok choy":"ü•¨","Cipollotto (Negi)":"üßÖ","Bamboo shoots":"üéç","Aglio & Zenzero":"üßÑ"
      };
      return m[label] || 'üç•';
    }

    function shortLabel(label){
      // rendi pi√π corto per visual
      return label.replace(/\s*\(.+\)/,'').replace('paste','').trim();
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    /**********************
     * BOOT
     **********************/
    createAudioControls();
    render();
  </script>
</body>
</html>
